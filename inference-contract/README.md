<!---
Licensed under Creative Commons Attribution 4.0 International License
https://creativecommons.org/licenses/by/4.0/
--->

# NFT and openvino inference contracts using PDO #
This directory contains the implementation of a Private Data Objects contract family that implements a machine learning (ML) model based digital asset for performing policy-based inferencing operations using the underlying ML model. The protocol used for binding the asset to its use-policy is largely similar to the one used within the [Digital Asset Contract Family](../digital-asset-contract/README.md). The Token Object PDO contract specifies and checks the policies to be followed to use the ML model for the inferecing operation. The asset guardian service is implemented as a web service containing a frontend and backend portions. In this implementation, the ML Model is assumed to be an [OpenVINO based IR](https://docs.openvino.ai/2023.2/openvino_ir.html) model.  The backend of the guardian service in this case implements the OpenVINO model server capable of performing inferencing operations using the OpenVINO IR model. The frontend of the guardian service at a high level performs two functions: 1. Processes the capability package generated by the token object and generates the API for the backend. 2. Implements any input preprocessing and output postprocessing (collectively referred to as model scoring)
as determined necessary by the original asset owner. 

The token object, as well as the asset guardian service are deployed by the asset owner, as part of the deployment sequence. The asset owner in addition authors the model scoring script that is executed as part of the guardian service frontend. Note that the model owner may use the token object to control key parameters used by the scoring script, and thus ensuring tight binding between the token object contract and the model usage.  

## Deploying the OpenVINO Model Server Backend for tests ##

Download the OpenVINO docker image.

```bash
docker pull openvino/model_server:latest
```

Our tests are based on the [classication demo model](https://github.com/openvinotoolkit/model_server/tree/main/demos/image_classification) contained within the OpenVINO repository. Please use the following commands use to download the model and deploy the OpenVINO model server docker container loaded with the classification model. 

```bash
mkdir -p imageclassification/model/1
wget -P imageclassification/model/1 https://storage.openvinotoolkit.org/repositories/open_model_zoo/2022.1/models_bin/2/resnet50-binary-0001/FP32-INT1/resnet50-binary-0001.bin
wget -P imageclassification/model/1 https://storage.openvinotoolkit.org/repositories/open_model_zoo/2022.1/models_bin/2/resnet50-binary-0001/FP32-INT1/resnet50-binary-0001.xml
docker run -d -u $(id -u):$(id -g) -v $(pwd)/imageclassification/model/:/models/ -p 127.0.0.1:9000:9000 openvino/model_server:latest --model_path /models/ --model_name resnet --port 9000 --shape auto
```

The model server endpoint is `127.0.0.1:9000`. Please note that we want the model server to be accessible only from the Guardian Service front end. In our tests, we assume that the Guardian Service and the model server are hosted on the same machine. The token owner (in practice siutated on a remote node) submits inference capability requests to the Guardian Service. The Guardian Service verifies the capability request,  gets its processed via the model server backend, and sends the result back to the token owner.

## Testing the inference contract ##

The tests assume that PDO services and ledger are up and running. Use the variables `F_SERVICE_HOST`and `PDO_LEDGER)URL` in `script_test.sh` to respectively specify the IP address for the PDO services and the URL For the PDO ledger. The script test will locally deploy the guardian service frontend necessary for the test. Note that the guardian front end uses a local storage service, that gets deployed (as part of the test script) prior to starting the front end. The storage service is used as an efficient means for the token owner to send potentially large input images for the inferencing operations.

```bash
cd $PDO_CONTRACTS_SOURCE_ROOT/inference-contract/test/
./script_test.sh
```