<!---
Licensed under Creative Commons Attribution 4.0 International License
https://creativecommons.org/licenses/by/4.0/
--->

# NFT and openvino inference contracts using PDO #

This directory contains a Private Data Objects contract family for
creating a confidentiality preserving policy-wrapper around the usage
of a machine learning (ML) model. At its core, the implementation
contains a Token Object PDO contract that specifies and checks the
policies to be followed while using the ML model for inferecing
operations. In this implementation, the ML Model is assumed to be an
[OpenVINO based IR](https://docs.openvino.ai/2023.2/openvino_ir.html)
model. The model itself is deployed via an asset guardian service; the
overall architecture of how a PDO token object gets used to manage an
asset deployed via an asset guardian service is largely similar to the
one used within the
[Digital Asset Contract Family](../digital-asset-contract/README.md).
Note that the
[Digital Asset Contract Family](../digital-asset-contract/README.md)
in turn relies on the
[Exchange Contracts](../exchange-contract/README.md)
for the foundational secure communication protocols between the Token
Object and the Asset Guardian Service.

The asset guardian service here is implemented as a web service
containing a frontend and backend portions.The backend of the guardian
service implements the OpenVINO model server capable of performing
inferencing operations using the OpenVINO IR model. The frontend of
the guardian service at a high level performs two
functions: 1. Processes the capability package generated by the token
object and generates/invokes the API for the backend. The capability
package may be thought of the asset-usage approval generated by the
token object smart contract. 2. Implements any input preprocessing and
output postprocessing (collectively referred to as model scoring) as
determined necessary by the original asset owner.

The token object, as well as the asset guardian service are deployed
by the asset owner, as part of the deployment sequence. The asset
owner in addition authors the model scoring script that is executed as
part of the guardian service frontend. Note that the asset owner may
use the token object to control key parameters used by the scoring
script, and thus ensuring tight binding between the token object
contract and the model usage.

We note that while the Token Object smart contract is executed within
Intel SGX enclaves (via PDO), the asset guardian service in this
impelementation is not protected by TEEs. A prospective asset-user
(token owner) relies on the asset owner for the trustworthiness of the
guardian service. However, it is entirely possible to extend the
protocols and implementation here to offer increased protection by
leveraging HW TEEs for the guardian service as well. Opensourcing of
additional security features is left for future work.


## Test Deployment of the OpenVINO Model Server Backend

Download the OpenVINO docker image.

```bash
docker pull openvino/model_server:latest
```

Our tests are based on the
[classication demo model](https://github.com/openvinotoolkit/model_server/tree/main/demos/image_classification)
contained within the OpenVINO repository. Please use the following
commands use to download the model and deploy the OpenVINO model
server docker container loaded with the classification model.

```bash
mkdir -p imageclassification/model/1
wget -P imageclassification/model/1 https://storage.openvinotoolkit.org/repositories/open_model_zoo/2022.1/models_bin/2/resnet50-binary-0001/FP32-INT1/resnet50-binary-0001.bin
wget -P imageclassification/model/1 https://storage.openvinotoolkit.org/repositories/open_model_zoo/2022.1/models_bin/2/resnet50-binary-0001/FP32-INT1/resnet50-binary-0001.xml
docker run -d -u $(id -u):$(id -g) -v $(pwd)/imageclassification/model/:/models/ -p 127.0.0.1:9000:9000 openvino/model_server:latest --model_path /models/ --model_name resnet --port 9000 --shape auto
```

The model server endpoint is `127.0.0.1:9000`. Please note that we
want the model server to be accessible only from the Guardian Service
frontend. In our tests, we assume that the Guardian Service and the
model server are hosted on the same machine. The token owner (in
practice situated on a remote node) submits inference reqeust first to
the token object, and gets back a capability package (see above for
definition). As a second step, the token owner submits the capability
package to the Guardian Service. The Guardian Service verifies the
capability package, gets it processed via the model server backend,
and sends the result back to the token owner.

Note that the port for the model server needs to be specified in the
config `etc/guardian_service.toml` (in addition to specifying as part
of the docker command above).

## Testing the inference contract ##

The tests assume that PDO services, the ledger and the OpenVINO model
server are up and running. Use the variables `F_SERVICE_HOST`and
`PDO_LEDGER_URL` in `script_test.sh` to respectively specify the IP
address for the PDO services and the URL for the PDO ledger. The
script test will locally deploy the guardian service frontend
necessary for the test. Note that the guardian frontend uses a local
storage service, that gets deployed (as part of the test script) prior
to starting the frontend. The storage service is used as an efficient
means for the token owner to send potentially large input images for
the inferencing operations.

```bash
cd $PDO_CONTRACTS_SOURCE_ROOT/inference-contract/test/
./script_test.sh
```

## Jupyter Notebooks for the Inference Contract ##

We provide [Jupyter Notebooks](./docs/notebooks/README.md) that can be executed
in an interactive manner to illustrate the functionality of the inference
contract family. The notebooks assume that the pdo services,
pdo ledger as well the asset guardian service are running prior to executing
notebook commands. As noted earlier, the guardian backend is the OpenVINO
model server; the `docker run` command provided above is used to deploy the
backend. The frontend can be deployed (on bare-metal) using the following
command:

```bash
cd $PDO_CONTRACTS_SOURCE_ROOT/inference-contract/test/
./guardian_frontend.sh
```
